'use strict';
var router = require('express').Router();
var _ = require('lodash');
var Jimp = require('jimp');
const svm = require('node-svm');
module.exports = router;
var negatives = [[[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[239, 235, 237], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[239, 235, 237], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[239, 235, 237], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[239, 235, 237], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[242, 238, 240], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[240, 236, 238], 0], [[240, 236, 238], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[242, 238, 240], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[243, 239, 241], 0], [[242, 238, 240], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0], [[241, 237, 239], 0]];
var imgPath = __dirname.replace(/app.*/, 'db/images/');
var sourceIMG = [];
var pixelArr = [];


router.get('/:animal', function (req, res, next) {
	Jimp.read(imgPath+req.params.animal+'.jpg')
	.then(function(img){
		img.scaleToFit(500,450);
		var width = img.bitmap.width;
		var height = img.bitmap.height;

		var colorArr = [];
		for (var x = 0; x < width; x++){
			pixelArr[x] = [];
			colorArr[x] = [];
			for (var y = 0; y < height; y++){
				var color = Jimp.intToRGBA(img.getPixelColor(x, y));
				sourceIMG.push([[color.r, color.g, color.b], x, y]);
				colorArr[x][y] = img.getPixelColor(x, y);
				pixelArr[x][y] = Jimp.intToRGBA(colorArr[x][y]);

			}
		}
		res.send(pixelArr);
	})
	.catch(next);
});


router.post('/', function(req, res, next){
	var trained = req.body.concat(negatives);
	var clf = new svm.CSVC();
	var predicted = [];
	clf.train(trained)
	.progress(function(rate){
		console.log(rate);
	})
	.done(function(){
		sourceIMG.forEach(function(each){
			var prediction = clf.predictSync(each[0]);
			if (prediction === 1) {
				predicted.push(each);
			}
		});
		res.send(predicted);
	});
});
